name: "滴滴加油站搜索爬虫"
description: "搜索不同地理位置的加油站信息"
version: "1.0"

variables:
  scroll_distance: 300
  station_data: []
  station_name_history: []
  search_locations: [
    "朝阳区",
    "海淀区", 
    "东城区",
    "西城区",
    "丰台区"
  ]

prerequisites:
  app:
    package: "com.didi.oil"

steps:
  - name: "启动应用"
    action: "start_app"
    params:
      package: "${prerequisites.app.package}"

  - name: "等待应用启动"
    action: "sleep"
    params:
      seconds: 1
      
  - name: "处理弹窗"
    action: "handle_popups_until_target"
    params:
      timeout: 30
      check_interval: 1
      screenshot_region: [0, 0, 1080, 2400]
      target_text: "输入目的地，查找附近加油站"
      popups:
        - name: "新人神券弹窗"
          patterns: ["新人天天神券掉落"]
          action: "click_region"
          click_region: [940, 600, 1080, 1100]
          priority: 1
        - name: "透明遮罩层"
          patterns: ["快来抢劵"]
          action: "click_region"
          click_region: [0, 1600, 1080, 1700]
          priority: 2

  - name: "循环搜索位置"
    action: "for_each"
    params:
      list: "${variables.search_locations}"
      variable: "current_location"
      steps:
        - name: "点击搜索栏"
          action: "wait_and_click_region"
          params:
            region: [50, 120, 400, 200]
            timeout: 10

        - name: "等待搜索页面加载"
          action: "sleep"
          params:
            seconds: 1

        - name: "检查历史搜索"
          action: "verify_text_in_region"
          params:
            region: [0, 300, 1080, 500]
            expected_text: "历史搜索"
            save_to: "has_search_history"

        - name: "清除搜索历史"
          action: "wait_and_click_region"
          params:
            region: [964, 410, 1080, 450]
          condition: "${has_search_history}"

        - name: "清空搜索框"
          action: "wait_and_click_region"
          params:
            region: [940, 220, 1060, 300]
            timeout: 5

        - name: "点击搜索框"
          action: "wait_and_click_region"
          params:
            region: [780, 220, 880, 300]
            timeout: 5

        - name: "等待输入框激活"
          action: "wait_for_input_ready"
          params:
            timeout: 5
            check_interval: 0.5

        - name: "输入搜索位置"
          action: "input_text"
          params:
            text: "${current_location}"

        - name: "等待搜索结果"
          action: "sleep"
          params:
            seconds: 1
            
        - name: "点击第一个搜索结果"
          action: "wait_and_click_region"
          params:
            region: [0, 500, 1080, 600]
            timeout: 5
            
        - name: "等待页面加载"
          action: "sleep"
          params:
            seconds: 2

        - name: "开始循环爬取"
          action: "loop"
          params:
            max_iterations: 30
            break_conditions:
              - type: "step_result"
                step: "检查重复加油站"
                value: true
            steps:
              - name: "点击一个加油站"
                action: "wait_and_click_region"
                params:
                  region: [0, 500, 1080, 700]

              - name: "等待加载"
                action: "sleep"
                params:
                  seconds: 1

              - name: "验证标题栏"
                action: "verify_text_in_region"
                params:
                  region: [400, 100, 680, 200]
                  expected_text: "滴滴加油"
                  match_type: "text"
                  save_to: "title_verified"

              - name: "动态调整滑动距离"
                action: "loop"
                params:
                  max_iterations: 10
                  break_conditions:
                    - type: "variable"
                      name: "title_verified"
                      value: true
                  steps:
                    - name: "小幅滑动"
                      action: "scroll"
                      params:
                        direction: "up"
                        distance: 50

                    - name: "再次点击加油站"
                      action: "wait_and_click_region"
                      params:
                        region: [0, 500, 1080, 700]
                        
                    - name: "等待加载"
                      action: "sleep"
                      params:
                        seconds: 1

                    - name: "验证标题栏"
                      action: "verify_text_in_region"
                      params:
                        region: [400, 100, 680, 200]
                        expected_text: "滴滴加油"
                        match_type: "text"
                        save_to: "title_verified"

              - name: "等待并定位关键元素"
                action: "wait_for_key_element"
                params:
                  text_pattern: "油站价¥"
                  match_type: "description_contains"
                  save_to: "price_element"
                  timeout: 10
                  interval: 0.4
                  contains_only: true

              - name: "获取加油站名称"
                action: "get_text_from_region"
                params:
                  relative_to: "price_element"
                  offset_top: -225
                  offset_bottom: -90
                  left: 50
                  right: 900
                  save_to: "current_station_name"
                  match_type: "description"
                  timeout: 3
                  interval: 0.3

              - name: "获取地址信息"
                action: "get_text_from_region"
                params:
                  relative_to: "price_element"
                  offset_top: -125
                  offset_bottom: -50
                  left: 50
                  right: 1400
                  save_to: "address_info"
                  match_type: "description"
                  timeout: 3
                  interval: 0.3

              - name: "获取92#油站价"
                action: "get_text_from_region"
                params:
                  element_pattern: "油站价¥"
                  match_type: "description_contains"
                  save_to: "station_price_92"
                  timeout: 3
                  interval: 0.3

              - name: "获取92#指导价"
                action: "get_text_from_region"
                params:
                  element_pattern: "指导价¥"
                  match_type: "description_contains"
                  save_to: "guide_price_92"
                  timeout: 3
                  interval: 0.3

              - name: "获取92#滴滴价"
                action: "get_node_by_path"
                params:
                  package: "com.didi.oil"
                  index_path:
                    - [0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 1, 2, 0, 0, 1]
                    - [0, 0, 0, 1, 0, 0, 0, 0, 0, 3, 0, 1, 0, 0, 3, 0, 0, 0, 1, 0, 1]
                    - [0 ,0 ,0, 1, 0, 0, 0, 0, 0, 3, 0, 1, 0, 0, 1, 2, 0, 0, 1]
                    - [0, 0, 0, 1, 0, 0, 1, 0, 0, 2, 0, 1, 0, 0, 3, 0, 0, 0, 1, 0, 1]
                  attributes:
                    - "content-desc"
                  pattern: "^\\d+\\.\\d{2}$"
                  save_to: "didi_price_92"
                  timeout: 3
                  interval: 0.3

              - name: "点击92#"
                action: "wait_and_click_node"
                params:
                  locate_by: "description"
                  text: "92#"
                  match_type: "exact"
                  timeout: 3
                  interval: 0.3
              
              - name: "等待列表刷新"
                action: "sleep"
                params:
                  seconds: 1

              - name: "获取92#油枪号列表"
                action: "get_node_descendants_content"
                params:
                  bounds: [0, 1542, 1080, 2262]
                  content_desc_pattern: "\\d+"
                  save_to: "gun_numbers_92"

              - name: "点击95#"
                action: "wait_and_click_node"
                params:
                  locate_by: "description"
                  text: "95#"
                  match_type: "exact"
                  timeout: 3
                  interval: 0.3

              - name: "获取95#油枪号列表"
                action: "get_node_descendants_content"
                params:
                  bounds: [0, 1542, 1080, 2262]
                  content_desc_pattern: "\\d+"
                  save_to: "gun_numbers_95"

              - name: "获取第一个95#油枪号"
                action: "get_list_item"
                params:
                  list: "gun_numbers_95"
                  index: 0
                  save_to: "first_gun_95"

              - name: "点击95#第一个油枪"
                action: "wait_and_click_node"
                params:
                  locate_by: "description"
                  text: "${first_gun_95}"
                  match_type: "exact"
                  timeout: 3
                  interval: 0.3

              - name: "等待加载"
                action: "sleep"
                params:
                  seconds: 0.5

              - name: "获取95#油站价"
                action: "get_text_from_region"
                params:
                  element_pattern: "油站价¥"
                  match_type: "description_contains"
                  save_to: "station_price_95"
                  timeout: 3
                  interval: 0.3

              - name: "获取95#指导价"
                action: "get_text_from_region"
                params:
                  element_pattern: "指导价¥"
                  match_type: "description_contains"
                  save_to: "guide_price_95"
                  timeout: 3
                  interval: 0.3

              - name: "获取95#滴滴价"
                action: "get_node_by_path"
                params:
                  package: "com.didi.oil"
                  index_path:
                    - [0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 1, 2, 0, 0, 1]
                    - [0, 0, 0, 1, 0, 0, 0, 0, 0, 3, 0, 1, 0, 0, 3, 0, 0, 0, 1, 0, 1]
                    - [0 ,0 ,0, 1, 0, 0, 0, 0, 0, 3, 0, 1, 0, 0, 1, 2, 0, 0, 1]
                    - [0, 0, 0, 1, 0, 0, 1, 0, 0, 2, 0, 1, 0, 0, 3, 0, 0, 0, 1, 0, 1]
                  attributes:
                    - "content-desc"
                  pattern: "^\\d+\\.\\d{2}$"
                  save_to: "didi_price_95"
                  timeout: 3
                  interval: 0.3

              - name: "保存数据"
                action: "append_to_list"
                params:
                  list: "station_data"
                  data:
                    name: "${current_station_name}"
                    station_price_92: "${station_price_92}"
                    guide_price_92: "${guide_price_92}"
                    didi_price_92: "${didi_price_92}"
                    station_price_95: "${station_price_95}"
                    guide_price_95: "${guide_price_95}"
                    didi_price_95: "${didi_price_95}"
                    address: "${address_info}"
                    search_key: "${current_location}"
                    gun_numbers_92: "${gun_numbers_92}"
                    gun_numbers_95: "${gun_numbers_95}"

              - name: "点击返回按钮"
                action: "wait_and_click_region"
                params:
                  region: [20, 120, 100, 200]

              - name: "等待首页刷新"
                action: "sleep"
                params:
                  seconds: 0.5

              - name: "向上滑动"
                action: "scroll"
                params:
                  direction: "up"
                  distance: "${variables.scroll_distance}"

              - name: "等待列表刷新"
                action: "sleep"
                params:
                  seconds: 3

              - name: "更新加油站历史"
                action: "append_to_list"
                params:
                  list: "station_name_history"
                  data: "${current_station_name}"
                  max_length: 3

              - name: "检查重复加油站"
                action: "check_repeated_value"
                params:
                  list: "station_name_history"
                  min_length: 3
                  save_to: "reached_bottom"

  - name: "导出数据"
    action: "export_data"
    params:
      data: "station_data"
      format: "json"
      filename: "gas_stations.json"

