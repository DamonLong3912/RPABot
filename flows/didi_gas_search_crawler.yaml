name: "滴滴加油站搜索爬虫"
description: "搜索不同地理位置的加油站信息"
version: "1.0"

variables:
  scroll_distance: 280
  station_data: []
  search_locations: [
    "beijing chaoyang qu",
    "beijing haidian qu", 
    "beijing dongcheng qu",
    "beijing xicheng qu",
    "beijing fengtai qu"
  ]

prerequisites:
  app:
    package: "com.didi.oil"

steps:
  - name: "启动应用"
    action: "start_app"
    params:
      package: "${prerequisites.app.package}"

  - name: "等待应用启动"
    action: "sleep"
    params:
      seconds: 3
      
  - name: "处理弹窗"
    action: "handle_popups_until_target"
    params:
      timeout: 30
      check_interval: 1
      screenshot_region: [0, 0, 1080, 2400]
      target_text: "输入目的地，查找附近加油站"
      target_clickable: false
      popups:
        - name: "新人神券弹窗"
          patterns: ["新人天天神券掉落"]
          action: "click_region"
          click_region: [980, 120, 1060, 200]
          priority: 1
        - name: "透明遮罩层"
          patterns: ["快来抢劵"]
          action: "click_region"
          click_region: [0, 1600, 1080, 1700]
          priority: 2

  - name: "循环搜索位置"
    action: "for_each"
    params:
      list: "${variables.search_locations}"
      variable: "current_location"
      steps:
        - name: "点击搜索栏"
          action: "wait_and_click_region"
          params:
            region: [50, 120, 400, 200]
            timeout: 10

        - name: "等待搜索页面加载"
          action: "sleep"
          params:
            seconds: 2

        - name: "检查历史搜索"
          action: "verify_text_in_region"
          params:
            region: [0, 300, 1080, 500]
            expected_text: "历史搜索"
            save_to: "has_search_history"

        - name: "清除搜索历史"
          action: "wait_and_click_region"
          params:
            region: [960, 400, 1080, 450]
          condition: "${has_search_history}"

        - name: "清空搜索框"
          action: "wait_and_click_region"
          params:
            region: [940, 220, 1060, 300]
            timeout: 5

        - name: "点击搜索框"
          action: "wait_and_click_region"
          params:
            region: [780, 220, 880, 300]
            timeout: 5

        - name: "等待输入框激活"
          action: "wait_for_input_ready"
          params:
            timeout: 5
            check_interval: 0.5

        - name: "输入搜索位置"
          action: "input_text"
          params:
            text: "${current_location}"

        - name: "点击第一个搜索结果"
          action: "wait_and_click_region"
          params:
            region: [0, 450, 1080, 550]
            timeout: 5
            
        - name: "等待结果加载"
          action: "sleep"
          params:
            seconds: 2

