name: "滴滴加油站信息爬取"
description: "自动爬取滴滴加油APP中的加油站信息"
version: "1.0"

variables:
  scroll_distance: 280  # 向上滑动的距离（像素）
  station_data: []     # 存储爬取的加油站数据

prerequisites:
  app:
    package: "com.didi.oil"

steps:
  - name: "启动应用"
    action: "start_app"
    params:
      package: "${prerequisites.app.package}"

  - name: "等待应用启动"
    action: "sleep"
    params:
      seconds: 3

  - name: "处理弹窗"
    action: "handle_popups_until_target"
    params:
      timeout: 30
      check_interval: 1
      screenshot_region: [0, 0, 1080, 2400]
      target_text: "输入目的地，查找附近加油站"
      target_clickable: false
      popups:
        - name: "新人神券弹窗"
          patterns: ["新人天天神券掉落"]
          action: "click_region"
          click_region: [940, 600, 1080, 1100]
          priority: 1
        - name: "透明遮罩层"
          patterns: ["快来抢劵"]
          action: "click_region"
          click_region: [0, 1600, 1080, 1700]
          priority: 2

  - name: "列表滚动到顶部"
    action: "scroll"
    params:
      direction: "up"
      distance: 600

  - name: "开始循环爬取"
    action: "loop"
    params:
      max_iterations: 100
      break_conditions:
        - type: "step_result"
          step: "检查是否到底"
          value: true
      steps:
        - name: "点击一个加油站"
          action: "wait_and_click_region"
          params:
            region: [0, 400, 1080, 700]

        - name: "等待加载"
          action: "sleep"
          params:
            seconds: 1

        - name: "验证标题栏"
          action: "verify_text_in_region"
          params:
            region: [400, 120, 680, 200]  # 标题栏区域
            expected_text: "滴滴加油"
            save_to: "title_verified"

        - name: "动态调整滑动距离"
          action: "loop"
          params:
            max_iterations: 10  # 最多尝试10次
            break_conditions:
              - type: "variable"
                name: "title_verified"
                value: true
            steps:
              - name: "小幅滑动"
                action: "scroll"
                params:
                  direction: "up"
                  distance: 50  # 每次小幅滑动50像素

              - name: "再次点击加油站"
                action: "wait_and_click_region"
                params:
                  region: [0, 400, 1080, 700]
                  
              - name: "等待刷新"
                action: "sleep"
                params:
                  seconds: 2

              - name: "验证标题栏"
                action: "verify_text_in_region"
                params:
                  region: [400, 120, 680, 200]
                  expected_text: "滴滴加油"
                  save_to: "title_verified"

        - name: "等待加载"
          action: "sleep"
          params:
            seconds: 1

        - name: "获取'详情'位置"
          action: "get_element_position"
          params:
            text: "详情"
            region: [0, 300, 1080, 1000]
            save_to: "detail_position"

        - name: "获取加油站名称"
          action: "get_text_from_region"
          params:
            region: [50, "${detail_position.y1 - 250}", 800, "${detail_position.y1 - 160}"]
            save_to: "current_station_name"

        - name: "获取地址信息"
          action: "get_text_from_region"
          params:
            region: [50, "${detail_position.y1 - 150}", 1050, "${detail_position.y1 - 90}"]
            save_to: "address_info"

        - name: "获取油价信息"
          action: "get_text_from_region"
          params:
            region: [50, "${detail_position.y1 - 80}", 1050, "${detail_position.y1 - 30}"]
            save_to: "price_info"

        - name: "保存数据"
          action: "append_to_list"
          params:
            list: "station_data"
            data:
              name: "${current_station_name}"
              price: "${price_info}"
              address: "${address_info}"

        - name: "点击返回按钮"
          action: "wait_and_click_region"
          params:
            region: [20, 120, 100, 200]  # 左上角返回按钮区域

        - name: "等待首页刷新"
          action: "sleep"
          params:
            seconds: 2

        - name: "向上滑动"
          action: "scroll"
          params:
            direction: "up"
            distance: "${variables.scroll_distance}"

        - name: "等待列表刷新"
          action: "sleep"
          params:
            seconds: 3

        - name: "检查是否到底"
          action: "verify_text_in_region"
          params:
            region: [0, 1800, 1080, 2200]
            expected_text: "到底了"
            save_to: "reached_bottom"

  - name: "导出数据"
    action: "export_data"
    params:
      data: "station_data"
      format: "json"
      filename: "gas_stations.json"